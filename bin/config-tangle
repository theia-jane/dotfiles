#!/usr/bin/env -S emacs -Q --script # -*- mode: emacs-lisp; lexical-binding: t; -*-
;; [[file:../config-cli.org::*Tangle][Tangle:1]]
(defvar config-root (replace-regexp-in-string "bin/[^/]+$" "" load-file-name))
(add-to-list 'load-path (concat config-root "tools/emacs/packages/"))

(require 'ob-tangle)
(require 'ob-extended-tangle)
(require 'ob-text-var-expansion)
(require 'ob-load-namespaced-libraries)
(require 'ob-var-table)
(require 'notifications)
;; Tangle:1 ends here

;; [[file:../config-cli.org::*Tangle][Tangle:2]]
(setq org-babel-default-header-args `((:session         . "none")
                                      (:noweb           . "yes")
                                      (:root-dir        . ,config-root)
                                      (:mkdirp          . "yes")
                                      (:tangle-relative . dir)
                                      (:tangle          . "no")
                                      (:comments        . "yes")))
;; Tangle:2 ends here

;; [[file:../config-cli.org::*Tangle][Tangle:3]]
(setq org-confirm-babel-evaluate nil)
(org-babel-do-load-languages 'org-babel-load-languages
    '((shell . t)
      (emacs-lisp . t)))
;; Tangle:3 ends here

;; [[file:../config-cli.org::*Tangle][Tangle:4]]
(add-hook 'after-save-hook
  'executable-make-buffer-file-executable-if-script-p)
;; Tangle:4 ends here

;; [[file:../config-cli.org::*Tangle][Tangle:5]]
(defun config-file-filter (file)
  (string-match
   (rx line-start
       (eval (file-name-as-directory config-root))
       (or "literate/"
           "tools/"
           (and (+ (not "/")) ".org")))
   file))

(defun config-files ()
  (seq-filter
   #'config-file-filter
   (directory-files-recursively config-root "\\.org$")))

(defun config-tangle ()
  (let ((files (config-files)))
    (message "Tangling files: %s" files)
    (with-ob-global-lib
     (ob-make-lib-from-files files t (lambda (file)
                                  (setq file (string-remove-prefix (file-name-as-directory config-root) file))
                                  (string-remove-suffix ".org" file)))
     (ob-tangle-files files))
    (notifications-notify :title "Config tangled"
                          :timeout 1500)))

(config-tangle)

(kill-emacs 0)
;; Tangle:5 ends here
